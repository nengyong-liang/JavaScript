name: è‡ªåŠ¨æ›´æ–°å°çº¢ä¹¦è„šæœ¬ç‰ˆæœ¬å·

on: # è§¦å‘æ¡ä»¶
  push:
    branches: #é‚£äº›åˆ†æ”¯è§¦å‘
      - main  # å¦‚æœä½ ç”¨çš„æ˜¯ main åˆ†æ”¯ï¼Œå¦åˆ™æ”¹æˆ master æˆ–å…¶ä»–

jobs:
  update-version:
    name: æ›´æ–°ç‰ˆæœ¬å·å¹¶æäº¤
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒ

    steps:
      #æ‹‰å–ä»£ç åˆ°å½“å‰å·¥ä½œç›®å½•ä¸­
      #actions/checkout çš„å®˜æ–¹æ’ä»¶ï¼ˆactionï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä»£ç åº“çš„å†…å®¹æ‹‰å–åˆ°å½“å‰çš„å·¥ä½œç›®å½•ä¸­ã€‚
      - name: ğŸ“‚ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ğŸ‘ˆ åŠ ä¸Šè¿™è¡Œå³å¯è§£å†³é—®é¢˜
        # æ‹‰å–å½“å‰åˆ†æ”¯çš„å®Œæ•´ Git å†å²ï¼ˆä¸æ˜¯æµ…å…‹éš†ï¼‰ï¼Œä»¥ä¾¿ä½ å¯ä»¥åœ¨åç»­æ­¥éª¤ä¸­ä½¿ç”¨ Git å‘½ä»¤åˆ†æå˜æ›´è®°å½•ï¼ˆæ¯”å¦‚æ£€æŸ¥å“ªäº› JS æ–‡ä»¶è¢«æ”¹åŠ¨äº†ï¼‰ã€‚   

      - name: ğŸ“… è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4 # è®¾ç½® Node.js ç¯å¢ƒ
        with: #ä¼ é€’å‚æ•°ç»™è¿™ä¸ª action
          node-version: 18 # ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ Node.js çš„ç‰ˆæœ¬å·

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm install date-fns #å®‰è£… date-fns è¿™ä¸ª JS åº“ï¼Œç”¨äºæ ¼å¼åŒ–æ—¥æœŸã€‚

      # ä½¿ç”¨ Node.js è¯»å†™æ–‡ä»¶ã€‚
      # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… @version è¡Œ,æ‰€ä»¥æ— è®º @version åé¢æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œéƒ½ä¼šè¢«æ›¿æ¢æˆæ–°çš„ç‰ˆæœ¬å·ã€‚
      # ä½¿ç”¨ date-fns æ ¼å¼åŒ–å½“å‰æ—¶é—´ã€‚
      # æŠŠæ–°ç‰ˆæœ¬å·å†™å…¥ç¯å¢ƒå˜é‡ $GITHUB_ENVã€‚
      - name: ğŸ”§ æ›¿æ¢è¢«ä¿®æ”¹ JS æ–‡ä»¶ä¸­çš„ @version å­—æ®µ
        id: replace_version
        run: |
          node -e '
            const fs = require("fs");
            const { execSync } = require("child_process");
            const path = require("path");
            const { format } = require("date-fns");
      
            // è·å–åŒ—äº¬æ—¶é—´
            const now = new Date();
            const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
            const version = `0.${format(beijingTime, "yyyyMMddHHmmss")}`;

            //æ‰“å°å‰10æ¬¡commitçš„å“ˆå¸Œ
            const output = execSync("git log --pretty=format:'%h' -n 10", { encoding: "utf-8" });
            console.log("git log --pretty=format:'%h' -n 10",output);
            
            //git diff HEAD^
            const output = execSync("git diff --name-only HEAD^", { encoding: "utf-8" });
            console.log("git diff --name-only HEAD^",output);

            const modifiedFiles = output.split("\n").filter(f => f.endsWith(".js"));

            //æ‰“å°modifiedFiles 
            console.log("modifiedFiles:", modifiedFiles);

            if (modifiedFiles.length === 0) {
              console.log("âœ… æ²¡æœ‰éœ€è¦æ›´æ–°ç‰ˆæœ¬å·çš„ JS æ–‡ä»¶ã€‚");
              process.exit(0);
            }
      
            let updatedFiles = [];

            // éå†ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Œè¯»å–å†…å®¹å¹¶æ›¿æ¢ @version è¡Œ
            for (const file of modifiedFiles) { 
              //æ‰“å°æ–‡ä»¶å
              console.log(`æ­£åœ¨å¤„ç†æ–‡ä»¶: ${file}`);
              const filePath = path.resolve(__dirname, file); // è·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
              //æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
              if (!fs.existsSync(filePath)) {
                console.warn(`âš ï¸ è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶: ${filePath}`);
                continue;
              }
              
              let content = fs.readFileSync(filePath, "utf-8");
              const newContent = content.replace(/\/\/ @version\s+.*/, `// @version     ${version}`);

              if (newContent !== content) {
                fs.writeFileSync(filePath, newContent);
                updatedFiles.push(file);
                console.log(`âœ… æ›´æ–°ç‰ˆæœ¬å·: ${file}`);
              } else {
                console.log(`â„¹ï¸ æ–‡ä»¶ä¸­æœªå‘ç° @version è¡Œ: ${file}`);
              }
            }
      
            if (updatedFiles.length === 0) {
              console.log("ğŸ“­ æ²¡æœ‰æ–‡ä»¶éœ€è¦æ›´æ–°ç‰ˆæœ¬å·");
              process.exit(0);
            }
      
            // è¾“å‡ºæ–‡ä»¶è·¯å¾„ä¾›åç»­ git add ä½¿ç”¨
            const files = updatedFiles.map(f => `"${f}"`).join(" ");
            fs.appendFileSync(process.env.GITHUB_ENV, `UPDATED_FILES=${files}\n`);
            fs.appendFileSync(process.env.GITHUB_ENV, `NEW_VERSION=${version}\n`);
          '
      

      # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯ã€‚
      # æ·»åŠ ä¿®æ”¹è¿‡çš„æ–‡ä»¶ã€‚
      # æäº¤å˜æ›´ï¼Œå¹¶é™„å¸¦åŒ…å«æ–°ç‰ˆæœ¬å·çš„ commit messageã€‚
      # æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œä½¿ç”¨ GitHub Token è¿›è¡Œèº«ä»½éªŒè¯ã€‚
      - name: ğŸ“¤ æäº¤æ›´æ”¹å¹¶æ¨é€
        #å¦‚æœifæ¡ä»¶æˆç«‹ï¼Œæ‰ä¼šæ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ã€‚
        if: env.UPDATED_FILES != '' 
        run: |
          echo "ifæˆç«‹,æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤"
          git config --local user.email "1598@qq.com"
          git config --local user.name "LNY_fake"      
          git add ${{ env.UPDATED_FILES }}
          git commit -m "ğŸ”§ è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·è‡³ ${{ env.NEW_VERSION }}"
          git push https://x-access-token:${{ secrets.LNY_GITHUB_TOKEN }}@github.com/nengyong-liang/JavaScript.git
      

