name: 自动更新小红书脚本版本号

on:
  push:
    branches:
      - main  # 如果你用的是 main 分支，否则改成 master 或其他

jobs:
  update-version:
    name: 更新版本号并提交
    runs-on: ubuntu-latest

    steps:
      - name: 📂 拉取代码
        uses: actions/checkout@v4

      - name: 📅 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: 📦 安装依赖
        run: npm install date-fns

      - name: 🔧 替换 @version 字段
        id: replace_version
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const { format } = require('date-fns');

            const scriptPath = path.join(__dirname, 'xiaohongshu', 'expand_reply_slide.js');
            let content = fs.readFileSync(scriptPath, 'utf-8');

            const now = new Date();
            const version = `0.6.${format(now, 'yyyyMMddHH')}`;
            const newContent = content.replace(
              /\/\/ @version\s+.*/,
              `// @version     ${version}`
            );

            fs.writeFileSync(scriptPath, newContent);
            console.log(`Updated version to ${version}`);
            process.env.NEW_VERSION = version;
          "

      - name: 📤 提交更改并推送
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add xiaohongshu/expand_reply_slide.js
          git commit -m "🔧 自动更新版本号至 ${{ env.NEW_VERSION }}"
          git push