name: è‡ªåŠ¨æ›´æ–°å°çº¢ä¹¦è„šæœ¬ç‰ˆæœ¬å·

on: # è§¦å‘æ¡ä»¶
  push:
    branches: #é‚£äº›åˆ†æ”¯è§¦å‘
      - main  # å¦‚æœä½ ç”¨çš„æ˜¯ main åˆ†æ”¯ï¼Œå¦åˆ™æ”¹æˆ master æˆ–å…¶ä»–

jobs:
  update-version:
    name: æ›´æ–°ç‰ˆæœ¬å·å¹¶æäº¤
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒ

    steps:
      - name: ğŸ“‚ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4 #actions/checkout çš„å®˜æ–¹æ’ä»¶ï¼ˆactionï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä»£ç åº“çš„å†…å®¹æ‹‰å–åˆ°å½“å‰çš„å·¥ä½œç›®å½•ä¸­ã€‚

      - name: ğŸ“… è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4 # è®¾ç½® Node.js ç¯å¢ƒ
        with: #ä¼ é€’å‚æ•°ç»™è¿™ä¸ª action
          node-version: 18 # ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ Node.js çš„ç‰ˆæœ¬å·

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm install date-fns #å®‰è£… date-fns è¿™ä¸ª JS åº“ï¼Œç”¨äºæ ¼å¼åŒ–æ—¥æœŸã€‚

      # ä½¿ç”¨ Node.js è¯»å†™æ–‡ä»¶ã€‚
      # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… @version è¡Œ,æ‰€ä»¥æ— è®º @version åé¢æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œéƒ½ä¼šè¢«æ›¿æ¢æˆæ–°çš„ç‰ˆæœ¬å·ã€‚
      # ä½¿ç”¨ date-fns æ ¼å¼åŒ–å½“å‰æ—¶é—´ã€‚
      # æŠŠæ–°ç‰ˆæœ¬å·å†™å…¥ç¯å¢ƒå˜é‡ $GITHUB_ENVã€‚
      - name: ğŸ”§ æ›¿æ¢ @version å­—æ®µ
        id: replace_version
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const { format } = require('date-fns');

            const scriptPath = path.join(__dirname, 'xiaohongshu', 'expand_reply_slide.js');
            let content = fs.readFileSync(scriptPath, 'utf-8');

            const now = new Date();
            const version = `0.6.${format(now, 'yyyyMMddHH')}`;
            const newContent = content.replace(
              /\/\/ @version\s+.*/,
              `// @version     ${version}`
            );

            fs.writeFileSync(scriptPath, newContent);
            console.log(`Updated version to ${version}`);
            process.env.NEW_VERSION = version;
          "



      # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯ã€‚
      # æ·»åŠ ä¿®æ”¹è¿‡çš„æ–‡ä»¶ã€‚
      # æäº¤å˜æ›´ï¼Œå¹¶é™„å¸¦åŒ…å«æ–°ç‰ˆæœ¬å·çš„ commit messageã€‚
      # æ¨é€åˆ°è¿œç¨‹ä»“åº“
      - name: ğŸ“¤ æäº¤æ›´æ”¹å¹¶æ¨é€
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add xiaohongshu/expand_reply_slide.js
          git commit -m "ğŸ”§ è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·è‡³ ${{ env.NEW_VERSION }}"
          git push