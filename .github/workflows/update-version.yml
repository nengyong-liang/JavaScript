name: è‡ªåŠ¨æ›´æ–°å°çº¢ä¹¦è„šæœ¬ç‰ˆæœ¬å·

on:
  push:
    branches:
      - main  # å¦‚æœä½ ç”¨çš„æ˜¯ main åˆ†æ”¯ï¼Œå¦åˆ™æ”¹æˆ master æˆ–å…¶ä»–

jobs:
  update-version:
    name: æ›´æ–°ç‰ˆæœ¬å·å¹¶æäº¤
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“… è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm install date-fns

      - name: ğŸ”§ æ›¿æ¢ @version å­—æ®µ
        id: replace_version
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');
            const { format } = require('date-fns');

            const scriptPath = path.join(__dirname, 'xiaohongshu', 'expand_reply_slide.js');
            let content = fs.readFileSync(scriptPath, 'utf-8');

            const now = new Date();
            const version = `0.6.${format(now, 'yyyyMMddHH')}`;
            const newContent = content.replace(
              /\/\/ @version\s+.*/,
              `// @version     ${version}`
            );

            fs.writeFileSync(scriptPath, newContent);
            console.log(`Updated version to ${version}`);
            process.env.NEW_VERSION = version;
          "

      - name: ğŸ“¤ æäº¤æ›´æ”¹å¹¶æ¨é€
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add xiaohongshu/expand_reply_slide.js
          git commit -m "ğŸ”§ è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·è‡³ ${{ env.NEW_VERSION }}"
          git push